import subprocess
import os
import argparse
import re

replace_words = [
    '.exe ',
    '.exe',
    '.EXE ',
    '.EXE'
]

def extract_program_names(file_path):
    # Set to hold unique program names
    program_names = set()
    
    with open(file_path, 'r') as file:
        text = file.read()
        
        matches = re.findall(r'^([^\(\),]+)\s*\(\d+\),', text, re.MULTILINE)
        
        for match in matches:
            if 'CodeSetup-stable' in match:
                continue
            for word in replace_words:
                if word in match:
                    match = match.replace(word, '')
            program_names.add(match)
    
    return sorted(program_names)

def run_exe(exe_path):
    if not os.path.isfile(exe_path):
        print(f"Executable {exe_path} does not exist.")
        return

    try:
        result = subprocess.run([exe_path], check=True, capture_output=True, text=True)
        print("Executable output:", result.stdout)
    except subprocess.CalledProcessError as e:
        print(f"Executable returned an error: {e.returncode}")
        print("Error output:", e.stderr)
    except Exception as e:
        print(f"An error occurred: {e}")
    
def run_python_script(script_path, *args):
    if not os.path.isfile(script_path):
        print(f"Script {script_path} does not exist.")
        return

    try:
        command = ['python', script_path] + list(args)
        result = subprocess.run(command, check=True, capture_output=True, text=True)
        print("Script output:", result.stdout)
    except subprocess.CalledProcessError as e:
        print(f"Script returned an error: {e.returncode}")
        print("Error output:", e.stderr)
    except Exception as e:
        print(f"An error occurred: {e}")

if __name__ == "__main__":
    current_directory = os.path.dirname(os.path.abspath(__file__))

    exe_to_run = os.path.join(current_directory, '..', 'extracting_data', 'extract_data.exe')
    exe_to_run = os.path.normpath(exe_to_run)

    print(f"Running executable: {exe_to_run}")
    run_exe(exe_to_run)

    py_script_path = os.path.join(current_directory, '..', 'extracting_data', 'extract_handles_data.py')
    py_script_path = os.path.normpath(py_script_path)

    modules_imports = os.path.join(current_directory, '..', 'list_MODULES_imports.txt')
    program_names = extract_program_names(modules_imports)
    #print(program_names)

    for name in program_names:
        print(f"Running script: {py_script_path} with argument '{name}'")
        run_python_script(py_script_path, name)